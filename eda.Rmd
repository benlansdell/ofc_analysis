---
title: "EDA"
output:
  html_document:
    df_print: paged
---

### Goals of notebook

* Basic data checks... any data is missing?
* Recording structure
* Examine just one recording right here. Can change the file and load others to compare later
* Look at the signals from trial to trial. This may inform normalization questions
* Make some plots of the signals from different cells

```{bash}
ls /media/core/core_operations/ImageAnalysisScratch/Schwarz/Cameron/ImagingData/
```

Choose a file from the above to analyze
```{r}
fn = 'final_060603.Rds'
```

And set this to your local working directory
```{r}
setwd('/home/blansdel/projects/roc_cell_analysis')
```

### Some basic data checks

Load and view the data
```{r}
library(data.table)
library(plotly)
library(ggplot2)
library(htmltools)

path = '/media/core/core_operations/ImageAnalysisScratch/Schwarz/Cameron/ImagingData/'
dt = readRDS(paste(path, fn, sep = ''))
dt
```

How many sessions, animals, rewards and events are there?

```{r}
dt[, .N, by=.(Session, Animal, Reward)]
```

```{r}
reward = unique(dt[,Reward])
```

```{r}
dt[, .(nframes = uniqueN(frame)), by=.(event)]
```

The sampling rate (Hz) is: 
```{r}
sr = 1/(dt[frame == 2, Time][1]-dt[frame == 1, Time][1])
sr
```

How long are each of the trials?
```{r}
dt[,.(nframes = uniqueN(`frame`)), by = .(`Trial Number`)]
```

Are there any missing time stamps/frames per cell?
```{r}
dt[, .(nframes = uniqueN(`frame`)),by = .(CellID)]
```

Are there any NAs?
```{r}
colSums(is.na(dt))
```

### Some exploration

Plot the signals for some randomly chosen cells (Plot with WebGL to make plotting this many data points faster)
```{r}
n_cells = 5
rnd_cells <- sample(unique(dt$CellID), n_cells, replace=F)
plots <- lapply(rnd_cells, function(idx) {
  
      plot_ly(data = dt[CellID == idx], x = ~Time, y = ~dff, type = "scatter", mode = "lines") %>%
    layout(title=sprintf("Cell #%s", idx)) %>% toWebGL()
})
tagList(plots)
```

Summarize activity for the cells. Make boxplots of signal for each cell
```{r fig1, fig.height = 20, fig.width = 5}
p <- ggplot(dt, aes(x=CellID, y=dff)) + geom_boxplot() + coord_flip()

p
```

What does the experiment progression look like for each trial? (WebGL for speed here too)
```{r}
  plot_ly(data = dt[CellID == "1"], x = ~Time, y = ~`Trial Number`, color = ~event, type = "scatter", mode = "markers") %>% toWebGL()
```

### Visualization of signal at spout_first events

We'll analyze activity at the start of these events:
```{r}
events_of_interest = c('lspout_first', 'rspout_first')
```

Only take the columns we need.
```{r}
ds = dt[,.(frame, CellID, `Trial Number`, event, dff)]
ds
```

Make indicator variables for the events of interest. 
```{r}
for (evt in events_of_interest) {
  ds[, (evt) := as.integer(event == evt)]
}
```

```{r}
ds
```

For each trial, where does each event of interest occur?
```{r}
for (evt in events_of_interest) {
  print(ds[event == evt, .SD[which.min(frame)], by = `Trial Number`])
}
```

Zero the frame count for each trial at the _first_ occurance of one of the events. If there are multiple transitions into the events throughout the trial, the latter occurances will be ignored here. 
```{r}
ds[, frame_offset_event := frame - min(.SD[event %in% events_of_interest, frame]), by = `Trial Number`]
ds
```

Now we can study the signal relative to these events for each cell. For each cell, we have 12 traces. 
```{r fig3, fig.height = 10, fig.width = 5}
window = 1000
n_cells = 15
rnd_cells <- sample(unique(dt$CellID), n_cells, replace=F)

ggplot(ds[CellID %in% rnd_cells & frame_offset_event > -window & frame_offset_event < window], 
       aes(x = frame_offset_event, y = dff, group = `Trial Number`, color = `event`)) + geom_line() + facet_grid(CellID ~.)
```

Zooming in to closer
```{r fig2, fig.height = 10, fig.width = 5}
window = 100
n_cells = 15
rnd_cells <- sample(unique(dt$CellID), n_cells, replace=F)

ggplot(ds[CellID %in% rnd_cells & frame_offset_event > -window & frame_offset_event < window], 
       aes(x = frame_offset_event, y = dff, group = `Trial Number`, color = `event`)) + geom_line() + facet_grid(CellID ~.)
```

Heatmap of the mean dff signal for each cell over all trials (regardless of which event it is)
```{r fig4, fig.height = 10, fig.width = 5}
window = 1000

p = ggplot(ds[frame_offset_event > -window & frame_offset_event < window, .(mn = mean(dff)), by = .(frame_offset_event, CellID)],
           aes(x=frame_offset_event, y=CellID, fill = mn)) + geom_tile(show.legend = FALSE) +   scale_fill_distiller(palette = "BrBG") + theme(axis.ticks.y = element_blank(), axis.text.y = element_blank(), axis.title.y = element_blank())
p
```

Narrower heatmap of the mean signal for each cell over all trials (regardless of which event it is)
```{r fig5, fig.height = 10, fig.width = 5}
window = 100
p = ggplot(ds[frame_offset_event > -window & frame_offset_event < window, .(mn = mean(dff)), by = .(frame_offset_event, CellID)],
           aes(x=frame_offset_event, y=CellID, fill = mn)) + geom_tile(show.legend = FALSE) + scale_fill_distiller(palette = "BrBG") + theme(axis.ticks.y = element_blank(), axis.text.y = element_blank(), axis.title.y = element_blank())
p
```

Now, let's split trials according to _the event of interest which occurs first_ and plot these mean activity traces again, per event of interest. 

```{r fig6, fig.height = 10, fig.width = 5}
window = 1000

#plots <- lapply(events_of_interest, function(evt) 
for (evt in events_of_interest) {
  trials = ds[event == evt, .SD[which.min(frame)], by = `Trial Number`]$`Trial Number`; 
  
  dss = ds[frame_offset_event > -window & frame_offset_event < window & `Trial Number` %in% trials, .(mn = mean(dff)), by = .(frame_offset_event, CellID)]; 
  
  p = ggplot(dss, aes(x=frame_offset_event, y=CellID, fill = mn)) + geom_tile(show.legend = FALSE) + scale_fill_distiller(palette = "BrBG") + theme(axis.ticks.y = element_blank(), axis.text.y = element_blank(), axis.title.y = element_blank()) + ggtitle(sprintf("%s (averaged over %d trials; reward is on the %s)", evt, length(trials), reward))

  print(p)  
}

```

A closer view
```{r fig7, fig.height = 10, fig.width = 5}
window = 200

#plots <- lapply(events_of_interest, function(evt) 
for (evt in events_of_interest) {
  trials = ds[event == evt, .SD[which.min(frame)], by = `Trial Number`]$`Trial Number`; 
  
  dss = ds[frame_offset_event > -window & frame_offset_event < window & `Trial Number` %in% trials, .(mn = mean(dff)), by = .(frame_offset_event, CellID)]; 
  
  p = ggplot(dss, aes(x=frame_offset_event, y=CellID, fill = mn)) + geom_tile(show.legend = FALSE) + scale_fill_distiller(palette = "BrBG") + theme(axis.ticks.y = element_blank(), axis.text.y = element_blank(), axis.title.y = element_blank()) + ggtitle(sprintf("%s (averaged over %d trials; reward is on the %s)", evt, length(trials), reward))

  print(p)  
}
```

### Cluster traces

For each cell and each trial, cluster dff 

### TODO

* Cluster analysis on traces

### Save ds datatable for loading in later notebooks

```{r}
save(ds, file = sprintf("./intermediate/0_datatablesfor_%s", fn))
```
